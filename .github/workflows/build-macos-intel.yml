name: build-macos-intel
on:
    workflow_dispatch:
        inputs:
            dry:
                default: false
                description: Prevent signing and upload
                required: false
                type: boolean
    workflow_call:
        inputs:
            dry:
                default: false
                description: Prevent signing and upload
                required: false
                type: boolean
        secrets:
            TAURI_PRIVATE_KEY:
                required: false
            TAURI_KEY_PASSWORD:
                required: false

permissions:
    contents: read

jobs:
    build-macos-intel:
        runs-on: macos-latest
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: lts/*

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7

            - uses: swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
              with:
                  workspaces: './src-tauri -> target'

            - name: Install pnpm
              run: arch -x86_64 npm install -g pnpm

            - name: Install Rosetta (Intel emulation)
              shell: bash
              run: |
                  set -euo pipefail
                  if ! /usr/bin/pgrep oahd >/dev/null 2>&1; then
                    softwareupdate --install-rosetta --agree-to-license
                  fi

            - name: Add Intel Rust target
              run: rustup target add x86_64-apple-darwin

            - name: Download & extract ONNX model (macOS)
              shell: bash
              run: |
                  set -euo pipefail
                  url="https://github.com/Kieirra/murmure-model/releases/download/1.0.0/parakeet-tdt-0.6b-v3-int8.zip"
                  tmp="$(mktemp -t model_zip_XXXXXX).zip"
                  echo "Downloading $url"
                  curl -L -o "$tmp" "$url"
                  echo "Unzipping into ./resources"
                  unzip -o "$tmp" -d resources
                  ls -al resources

            - name: Install frontend deps
              run: arch -x86_64 pnpm install

            - name: Build Intel DMG
              run: arch -x86_64 pnpm tauri build --target x86_64-apple-darwin --bundles dmg

            - name: Restore Tauri signing key
              if: ${{ inputs.dry == false }}
              shell: bash
              env:
                  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
              run: |
                  set -euo pipefail
                  if [ -n "${TAURI_PRIVATE_KEY:-}" ]; then
                    echo "$TAURI_PRIVATE_KEY" | (base64 --decode 2>/dev/null || base64 -D) > tauri.key
                  else
                    echo "No TAURI_PRIVATE_KEY provided; skipping key restoration."
                  fi

            - name: Sign DMG(s) with Tauri signer
              if: ${{ inputs.dry == false }}
              env:
                  TAURI_PRIVATE_KEY_PATH: tauri.key
                  TAURI_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
              shell: bash
              run: |
                  set -euo pipefail
                  if [ -f tauri.key ]; then
                    bundle_dir="src-tauri/target/x86_64-apple-darwin/release/bundle"
                    files=$(find "$bundle_dir" -type f -name "*.dmg")
                    if [ -n "$files" ]; then
                      pnpm tauri signer sign $files
                    else
                      echo "No DMG found to sign."
                    fi
                  else
                    echo "No signing key available, skipping Tauri signing."
                  fi

            - name: Rename DMG files to Intel suffix
              if: ${{ inputs.dry == false }}
              shell: bash
              run: |
                  set -euo pipefail
                  bundle_dir="src-tauri/target/x86_64-apple-darwin/release/bundle"
                  find "$bundle_dir" -name "*.dmg" -exec sh -c 'mv "$1" "$(dirname "$1")/Murmure_x86_64_darwin.dmg"' _ {} \;
                  find "$bundle_dir" -name "*.sig" -exec sh -c 'mv "$1" "$(dirname "$1")/Murmure_x86_64_darwin.dmg.sig"' _ {} \; 2>/dev/null || true

            - name: Upload artifact (1 day)
              if: ${{ inputs.dry == false }}
              uses: actions/upload-artifact@v4
              with:
                  name: murmure-macos-intel
                  path: |
                      src-tauri/target/x86_64-apple-darwin/release/bundle/**/*.dmg
                      src-tauri/target/x86_64-apple-darwin/release/bundle/**/*.sig
                  retention-days: 1
                  if-no-files-found: ignore
